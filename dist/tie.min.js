/*!
 TieJS - http://develman.github.io/tiejs
 Licensed under the MIT license
 Copyright (c) 2014 Georg Henkel <georg@develman.de>, Christoph Huppertz <huppertz.chr@gmail.com>
 */
!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function($){"use strict";var TieJS=function(form,options){function _initForm(){if(settings.formName&&$form.attr("name",settings.formName),settings.showRequiredAsterisk){var a=$("<p class='required-info'>Mit <span class='required-sign'>*</span> markierte Felder sind Pflichtfelder</p>");$form.prepend(a)}$form.addClass("tiejs-form"),$form.one("submit",function(a){a.preventDefault(),_validate($form,fieldNames)&&settings.onSubmit($form)})}function _clearMarker(a){a.find("div.alert").remove(),a.find(".has-error").each(function(a,b){$(b).removeClass("has-error has-feedback"),$(b).find(".form-control-feedback").remove()})}function _hasAttribute(a,b){var c=$(a).attr(b);return"undefined"!=typeof c&&c!==!1}function _addFormError(a,b){var c=$(".formerror");0===c.length&&(c=$("<div></div>"),c.addClass("formerror alert alert-danger"),a.prepend(c)),c.text(void 0===b?"Bitte beheben Sie die im Formular hervorgehobenen Fehler":b)}function _addFieldError(a){var b=a.parent();b.hasClass("input-group")&&(b=b.parent()),b.addClass("has-error has-feedback"),b.append(a.is("select")?"<span class='fa fa-times form-control-feedback feedback-select'></span>":"<span class='fa fa-times form-control-feedback'></span>")}function _updateFieldData(a,b,c){var d=a.attr("type");switch(d){case"checkbox":var e=b[c];0===e?a.prop("checked",!1):a.prop("checked",!0);break;case"radio":a.val([b[c]]);break;case"select":if($(a).hasClass("tags")){var f=[];b[c].forEach(function(a){f.push(a)}),a.val(f)}else{var g=a.find("option");g.each(function(d){$(g[d]).attr("data-type")===b[c]&&a.val($(g[d]).val())})}break;default:var h=b[c];a.val(h)}}function _findInArray(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d.name===a)return d}return null}var self=$(this),$form=$(form),fieldNames=[],settings=$.extend({showRequiredAsterisk:!0,formName:null,bindingSource:{},onSubmit:function(){}},options);_initForm(),this.addFields=function(a){return $.each(a,function(a,b){b.data&&($form.append(_addField(b.type,b.data)),null===_findInArray(b.data.name,fieldNames)&&fieldNames.push({name:b.data.name,binding:""}))}),this},this.addColumns=function(a){return a.length>0&&$form.append(_addColumns(a,fieldNames)),this},this.addBindings=function(bindings){return settings.bindingSource&&$.each(bindings,function(index,binding){$.each(binding,function(fieldName,property){var binding=settings.bindingSource;if(-1!=property.indexOf(".")){var lastPointIdx=property.lastIndexOf("."),namespace=property.substr(0,lastPointIdx);property=property.substr(lastPointIdx+1);var tmp="settings.bindingSource."+namespace;binding=eval(tmp)}_bind($form,binding,fieldName,property);var fieldNameData=_findInArray(fieldName,fieldNames);fieldNameData.binding=property})}),this},this.captureFields=function(){return $form.find(":input:not(:button)").each(function(a,b){var c=$(b).attr("name");null===_findInArray(c,fieldNames)&&fieldNames.push({name:c,binding:""})}),this},this.updateSettings=function(a){$.extend(settings,a),this.reload()},this.reload=function(){_clearMarker($form),$.each(fieldNames,function(a,b){_bind($form,settings.bindingSource,b.name,b.binding)})},this.markFieldError=function(a,b){$.each(a,function(a,b){var c=$form.find("[name="+b+"]");_addFieldError(c)}),_addFormError($form,b)};var _addField=function(a,b){var c=null;switch(a){case"text":case"number":case"email":case"password":case"regex":c=_defaultField(a,b);break;case"checkbox":c=_checkboxField(b);break;case"radio":c=_radioField(b);break;case"select":c=_selectField(b,!1);break;case"tags":c=_selectField(b,!0);break;case"color":c=_colorField(b);break;case"date":c=_dateField(b);break;case"time":c=_timeField(b);break;case"longtext":c=_textareaField(b);break;case"wysiwyg":c=_wysiwygField(b);break;case"button":c=_button(b)}return c},_addColumns=function(a,b){var c=$("<div></div>");return c.addClass("row"),$.each(a,function(a,d){var e=$("<div></div>");e.addClass("col-md-6"),d.data&&(e.append(_addField(d.type,d.data)),null===_findInArray(d.data.name,b)&&b.push({name:d.data.name,binding:""})),c.append(e)}),c},_bind=function(a,b,c,d){var e=a.find("[name="+c+"]");if(e&&"undefined"!=typeof b[d]){e.is("select")&&e.attr("type","select");var f=e.attr("type");a.on("change",e,function(g){if(e.attr("name")===$(g.target).attr("name")){var h;switch(f){case"checkbox":h=e.is(":checked")?1:0,b[d]=h;break;case"radio":h=a.find("input[name="+c+"]:checked").val(),b[d]=h;break;case"select":$(g.target).hasClass("tags")||(h=a.find("select[name="+c+"] option:selected").val(),b[d]=h);break;default:b[d]=e.val()}}}),_updateFieldData(e,b,d)}},_validate=function(a,b){_clearMarker(a);var c=!0;return $.each(b,function(b,d){var e=a.find("[name="+d.name+"]"),f=e.val();_hasAttribute(e,"required")&&(!f||e.is("select")&&"0"==f)&&(c=!1,_addFieldError(e));var g,h=e.attr("type");switch(h){case"number":f&&!$.isNumeric(f)&&(c=!1,_addFieldError(e));break;case"email":g=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,f&&!g.test(f)&&(c=!1,_addFieldError(e))}var i=e.attr("data-regex");i&&(g=new RegExp(i),f&&!g.test(f)&&(c=!1,_addFieldError(e)))}),c||_addFormError(a),c},_defaultField=function(a,b){var c=$("<div></div>");c.addClass("form-group");var d=b.label;settings.showRequiredAsterisk&&b.required&&(d+="<span class='required-sign'>*</span>"),c.append("<label class='control-label'>"+d+":</label>");var e="<input type='"+a+"' name='"+b.name+"' class='form-control'";return b.css&&(e=e.slice(0,-1),e+=" "+b.css+"'"),b.placeholder&&(e+=" placeholder='"+b.placeholder+"'"),b.attributes&&(e+=" "+b.attributes),b.required&&(e+=" required"),b.regex&&(e+=" data-regex='"+b.regex+"'"),e+=" />",c.append(e),c},_checkboxField=function(a){var b=$("<div></div>");b.addClass("checkbox");var c=$("<label></label>");c.addClass("control-label");var d="<input type='checkbox' name='"+a.name+"'";a.css&&(d+=" class='"+a.css+"'"),a.attributes&&(d+=" "+a.attributes),a.required&&(d+=" required"),d+=" />",c.append(d);var e=a.label;return settings.showRequiredAsterisk&&a.required&&(e+="<span class='required-sign'>*</span>"),c.append(e),b.append(c),b},_radioField=function(a){var b=$("<div></div>");b.addClass("radio");var c=$("<label></label>");c.addClass("control-label");var d="<input type='radio' name='"+a.name+"'";a.css&&(d+=" class='"+a.css+"'"),a.attributes&&(d+=" "+a.attributes),a.required&&(d+=" required"),d+=" />",c.append(d);var e=a.label;return settings.showRequiredAsterisk&&a.required&&(e+="<span class='required-sign'>*</span>"),c.append(e),b.append(c),b},_selectField=function(a,b){var c=$("<div></div>");c.addClass("form-group");var d=a.label;settings.showRequiredAsterisk&&a.required&&(d+="<span class='required-sign'>*</span>");var e="'form-control'";b&&(e="'form-control tags chosen-select' multiple",a.placeholder&&(e+=" data-placeholder='"+a.placeholder+"'")),c.append("<label class='control-label'>"+d+":</label>");var f="<select name='"+a.name+"' class="+e;return a.css&&(f=input.slice(0,-1),f+=" "+a.css+"'"),a.attributes&&(f+=" "+a.attributes),a.required&&(f+=" required"),f+=">",a.placeholder&&!b&&(f+="<option value='0' disabled selected>"+a.placeholder+"</option>"),a.options&&$.each(a.options,function(a,b){f+="<option value='"+b.id+"' data-type='"+b.type+"'>"+b.name+"</option>"}),a.url&&$.ajax({type:"GET",url:a.url,async:!1,success:function(a){var b=JSON.parse(a);b.forEach(function(a){f+="<option value='"+a.Id+"' data-type='"+a.Type+"'>"+a.Name+"</option>"})},error:function(a,b){console&&console.log("tiejs: error loading select options from server, status: "+b)}}),f+="</select>",c.append(f),c},_colorField=function(a){var b=$("<div></div>");b.addClass("form-group");var c=a.label;settings.showRequiredAsterisk&&a.required&&(c+="<span class='required-sign'>*</span>"),b.append("<label class='control-label'>"+c+":</label>");var d=$("<div></div>");d.addClass("input-group color");var e="<input type='text' name='"+a.name+"' class='form-control'";a.css&&(e=e.slice(0,-1),e+=" "+a.css+"'"),a.placeholder&&(e+=" placeholder='"+a.placeholder+"'"),a.attributes&&(e+=" "+a.attributes),a.required&&(e+=" required"),e+=" />";var f=$("<span></span>");return f.addClass("input-group-addon"),f.html("<i></i>"),d.append(e),d.append(f),b.append(d),b},_dateField=function(a){var b=$("<div></div>");b.addClass("form-group");var c=a.label;settings.showRequiredAsterisk&&a.required&&(c+="<span class='required-sign'>*</span>"),b.append("<label class='control-label'>"+c+":</label>");var d=$("<div></div>");d.addClass("input-group date");var e="<input type='text' name='"+a.name+"' class='form-control' data-date-format='"+a.format+"'";a.css&&(e=e.slice(0,-1),e+=" "+a.css+"'"),a.placeholder&&(e+=" placeholder='"+a.placeholder+"'"),a.attributes&&(e+=" "+a.attributes),a.regex&&(e+=" data-regex='"+a.regex+"'"),a.required&&(e+=" required"),e+=" />";var f=$("<span></span>");return f.addClass("input-group-addon"),f.html('<i class="fa fa-calendar"></i>'),d.append(e),d.append(f),b.append(d),b},_timeField=function(a){var b=$("<div></div>");b.addClass("form-group");var c=a.label;settings.showRequiredAsterisk&&a.required&&(c+="<span class='required-sign'>*</span>"),b.append("<label class='control-label'>"+c+":</label>");var d=$("<div></div>");d.addClass("input-group time");var e="<input type='text' name='"+a.name+"' class='form-control'";a.css&&(e=e.slice(0,-1),e+=" "+a.css+"'"),a.placeholder&&(e+=" placeholder='"+a.placeholder+"'"),a.attributes&&(e+=" "+a.attributes),a.regex&&(e+=" data-regex='"+a.regex+"'"),a.required&&(e+=" required"),e+=" />";var f=$("<span></span>");return f.addClass("input-group-addon"),f.html('<i class="fa fa-clock-o"></i>'),d.append(e),d.append(f),b.append(d),b},_textareaField=function(a){var b=$("<div></div>");b.addClass("form-group");var c=a.label;settings.showRequiredAsterisk&&a.required&&(c+="<span class='required-sign'>*</span>"),b.append("<label class='control-label'>"+c+":</label>");var d="<textarea name='"+a.name+"' class='form-control'";return a.css&&(d=d.slice(0,-1),d+=" "+a.css+"'"),a.placeholder&&(d+=" placeholder='"+a.placeholder+"'"),a.attributes&&(d+=" "+a.attributes),a.required&&(d+=" required"),d+="></textarea>",b.append(d),b},_wysiwygField=function(a){var b=$("<div></div>");b.addClass("form-group");var c=a.label;b.append("<label class='control-label'>"+c+":</label>");var d="<div name='"+a.name+"' class='form-control wysiwyg'";return a.css&&(d=d.slice(0,-1),d+=" "+a.css+"'"),a.placeholder&&(d+=" placeholder='"+a.placeholder+"'"),a.attributes&&(d+=" "+a.attributes),a.required&&(d+=" required"),d+="></div>",b.append(d),b},_button=function(a){var b=$("<div></div>");b.addClass("form-group");var c="<button type='button' class='btn btn-default'";if(a.css&&(c=c.slice(0,-1),c+=" "+a.css+"'"),c+=">"+a.label+"</button>",b.append(c),a.clickCB){var d=b.find("button");$(d).on("click",a.clickCB)}return b}};$.fn.TieJS=function(a){return this.each(function(){var b=$(this);b.data("tiejs")||b.data("tiejs",new TieJS(this,a))})}});